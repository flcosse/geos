<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="auteur" content="">
<link rel="icon" href="imagr/planet-earth.png">
<title>Occupation du sol</title>
<!-- Bootstrap core CSS -->
<link href="assets/css/bootstrap.min.css" rel="stylesheet">
<!-- Fonts -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
<!-- Custom styles for this template -->
<link href="assets/css/mediumish.css" rel="stylesheet">
</head>
<body>
    <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
	
		
	</body>
<!-- Begin Nav
================================================== -->
<nav class="navbar navbar-toggleable-md navbar-light bg-white fixed-top mediumnavigation">
<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="container">
	<!-- Begin Logo -->
	<a class="navbar-brand" href="index.html">
	
	</a>
	<!-- End Logo -->
	<div class="collapse navbar-collapse" id="navbarsExampleDefault">
		<!-- Begin Menu -->
		<a class="navbar-brand" href="index.html">
            <img src="imagr/planet-earth.png" alt="logo">
            </a>
		<ul class="navbar-nav ml-auto">
			<li class="nav-item active">
			<a class="nav-link" href="propos.html">A propos <span class="sr-only">(current)</span></a>
			</li>
			
		</ul>
		<!-- End Menu -->
		<!-- Begin Search -->
		<form class="form-inline my-2 my-lg-0">
			<input class="form-control mr-sm-2" type="text" placeholder="Search">
			<span class="search-icon"><svg class="svgIcon-use" width="25" height="25" viewbox="0 0 25 25"><path d="M20.067 18.933l-4.157-4.157a6 6 0 1 0-.884.884l4.157 4.157a.624.624 0 1 0 .884-.884zM6.5 11c0-2.62 2.13-4.75 4.75-4.75S16 8.38 16 11s-2.13 4.75-4.75 4.75S6.5 13.62 6.5 11z"></path></svg></span>
		</form>
		<!-- End Search -->
	</div>
</div>
</nav>
<!-- End Nav
================================================== -->

<!-- Begin Article
================================================== -->
<div class="container">
	<div class="row">

		<!-- Begin Fixed Left Share -->
		<div class="col-md-2 col-xs-12">
			<div class="share">
				
			</div>
		</div>
		<!-- End Fixed Left Share -->

		<!-- Begin Post -->
		<div class="col-md-8 col-md-offset-2 col-xs-12">
			<div class="mainheading">

				<!-- Begin Top Meta -->
				
				<!-- End Top Menta -->

				<h1 class="posttitle">Visualisation des données "landuse" d'OpenStreetMap avec PyQGIS</h1>
				
			</div>
            <div class="after-post-tags">
				<ul class="tags">
					<li><a href="#">Python</a></li>
					<li><a href="#">OpenStreetMap</a></li>
					<li><a href="#">Plotly</a></li>
					<li><a href="#">Plugin</a></li>
                    <li><a href="#">Pandas</a></li>
				</ul>
			</div>

			<!-- Begin Featured Image -->
            <p>
                Ce diagramme utilise les données d'OpenStreetMap récupérés à partir de l'extension QuickOSM. Des calculs automatique, avec la calculatrice de champs et Pandas, sont faits pour récupérer les superficies et leurs attributs. Le graphique est généré par Plotly.
            </p>
			<!-- Begin Featured Image -->
			
			<iframe src="file.html"scrolling="no"frameBorder="0" height="60%" width="80%" title="Iframe Example" style="margin-left: 14%;"></iframe>
			<!-- End Featured Image -->

			<!-- Begin Post Content -->
			<pre><code class="python">import numpy as np
import pandas as pd
import plotly.express as px

ville = "Pontacq"
outpt = "C:/Users/Florian/Desktop/sortie.gpkg"
processing.run("quickosm:downloadosmdatainareaquery", 
{'KEY':'landuse',
'VALUE':"",
'AREA':ville,
'TIMEOUT':120,
'SERVER':'https://lz4.overpass-api.de/api/interpreter',
'FILE':outpt})
iface.addVectorLayer("C:/Users/Florian/Desktop/sortie.gpkg|layername=sortie_multipolygons","","ogr")

landuse1 = QgsProject.instance().mapLayersByName('sortie sortie_multipolygons')[0]
inpt = QgsVectorLayer('C:/Users/Florian/Desktop/sortie.gpkg|layername=sortie_multipolygons',"","ogr")

processing.run("native:reprojectlayer", 
{'INPUT':inpt,
'TARGET_CRS':QgsCoordinateReferenceSystem('EPSG:2154'),
'OPERATION':'+proj=pipeline +step +proj=unitconvert +xy_in=deg +xy_out=rad +step +proj=lcc +lat_0=46.5 +lon_0=3 +lat_1=49 +lat_2=44 +x_0=700000 +y_0=6600000 +ellps=GRS80',
'OUTPUT':'C:/Users/Florian/Desktop/poly.shp'})
iface.addVectorLayer("C:/Users/Florian/Desktop/poly.shp","","ogr")
landuse1 = QgsProject.instance().mapLayersByName('poly')[0]

column = QgsField("aire",QVariant.Double)
landuse1.dataProvider().addAttributes([column])
landuse1.updateFields()
exp1 = QgsExpression("$area")
QgsProject.instance().addMapLayer(landuse1)
dehors ="C:/Users/Florian/Desktop/zebi.gpkg"
processing.run("native:refactorfields",
{'INPUT':'C:/Users/Florian/Desktop/poly.shp','FIELDS_MAPPING':[{'expression': '\"fid\"','length': 0,'name': 'fid','precision': 0,'type': 4},{'expression': '\"full_id\"','length': 0,'name': 'full_id','precision': 0,'type': 10},{'expression': '\"osm_id\"','length': 0,'name': 'osm_id','precision': 0,'type': 10},{'expression': '\"osm_type\"','length': 0,'name': 'osm_type','precision': 0,'type': 10},{'expression': '\"check_date\"','length': 0,'name': 'check_date','precision': 0,'type': 10},{'expression': '\"end_date\"','length': 0,'name': 'end_date','precision': 0,'type': 10},{'expression': '\"substance\"','length': 0,'name': 'substance','precision': 0,'type': 10},{'expression': '\"pipeline\"','length': 0,'name': 'pipeline','precision': 0,'type': 10},{'expression': '\"industrial\"','length': 0,'name': 'industrial','precision': 0,'type': 10},{'expression': '\"capacity:disabled\"','length': 0,'name': 'capacity:disabled','precision': 0,'type': 10},{'expression': '\"aire\"','length': 0,'name': 'aire','precision': 0,'type': 6},{'expression': '\"depot\"','length': 0,'name': 'depot','precision': 0,'type': 10},{'expression': '\"user\"','length': 0,'name': 'user','precision': 0,'type': 10},{'expression': '\"parking\"','length': 0,'name': 'parking','precision': 0,'type': 10},{'expression': '\"park_ride\"','length': 0,'name': 'park_ride','precision': 0,'type': 10},{'expression': '\"operator:type\"','length': 0,'name': 'operator:type','precision': 0,'type': 10},{'expression': '\"fee\"','length': 0,'name': 'fee','precision': 0,'type': 10},{'expression': '\"capacity\"','length': 0,'name': 'capacity','precision': 0,'type': 10},{'expression': '\"amenity\"','length': 0,'name': 'amenity','precision': 0,'type': 10},{'expression': '\"leisure\"','length': 0,'name': 'leisure','precision': 0,'type': 10},{'expression': '\"access\"','length': 0,'name': 'access','precision': 0,'type': 10},{'expression': '\"description\"','length': 0,'name': 'description','precision': 0,'type': 10},{'expression': '\"substation\"','length': 0,'name': 'substation','precision': 0,'type': 10},{'expression': '\"power\"','length': 0,'name': 'power','precision': 0,'type': 10},{'expression': '\"start_date\"','length': 0,'name': 'start_date','precision': 0,'type': 10},{'expression': '\"addr:street\"','length': 0,'name': 'addr:street','precision': 0,'type': 10},{'expression': '\"addr:postcode\"','length': 0,'name': 'addr:postcode','precision': 0,'type': 10},{'expression': '\"addr:housenumber\"','length': 0,'name': 'addr:housenumber','precision': 0,'type': 10},{'expression': '\"addr:city\"','length': 0,'name': 'addr:city','precision': 0,'type': 10},{'expression': '\"natural\"','length': 0,'name': 'natural','precision': 0,'type': 10},{'expression': '\"sport\"','length': 0,'name': 'sport','precision': 0,'type': 10},{'expression': '\"intermittent\"','length': 0,'name': 'intermittent','precision': 0,'type': 10},{'expression': '\"wall\"','length': 0,'name': 'wall','precision': 0,'type': 10},{'expression': '\"building\"','length': 0,'name': 'building','precision': 0,'type': 10},{'expression': '\"leaf_type\"','length': 0,'name': 'leaf_type','precision': 0,'type': 10},{'expression': '\"CLC:year\"','length': 0,'name': 'CLC:year','precision': 0,'type': 10},{'expression': '\"CLC:id\"','length': 0,'name': 'CLC:id','precision': 0,'type': 10},{'expression': '\"CLC:code\"','length': 0,'name': 'CLC:code','precision': 0,'type': 10},{'expression': '\"wikipedia\"','length': 0,'name': 'wikipedia','precision': 0,'type': 10},{'expression': '\"research\"','length': 0,'name': 'research','precision': 0,'type': 10},{'expression': '\"operator\"','length': 0,'name': 'operator','precision': 0,'type': 10},{'expression': '\"alt_name\"','length': 0,'name': 'alt_name','precision': 0,'type': 10},{'expression': '\"religion\"','length': 0,'name': 'religion','precision': 0,'type': 10},{'expression': '\"denomination\"','length': 0,'name': 'denomination','precision': 0,'type': 10},{'expression': '\"barrier\"','length': 0,'name': 'barrier','precision': 0,'type': 10},{'expression': '\"residential\"','length': 0,'name': 'residential','precision': 0,'type': 10},{'expression': '\"opening_hours\"','length': 0,'name': 'opening_hours','precision': 0,'type': 10},{'expression': '\"website\"','length': 0,'name': 'website','precision': 0,'type': 10},{'expression': '\"name\"','length': 0,'name': 'name','precision': 0,'type': 10},{'expression': '\"type\"','length': 0,'name': 'type','precision': 0,'type': 10},{'expression': '\"landuse\"','length': 0,'name': 'landuse','precision': 0,'type': 10}],'OUTPUT':dehors})
iface.addVectorLayer(dehors,"","ogr")
landuse = QgsProject.instance().mapLayersByName('zebi')[0]
context = QgsExpressionContext()
context.appendScopes(QgsExpressionContextUtils.globalProjectLayerScopes(landuse))

output2 = "C:/Users/Florian/Desktop/découpé.shp"
processing.run("native:clip", 
{'INPUT':'C:/Users/Florian/Desktop/poly.shp',
'OVERLAY':'C:/Users/Florian/Desktop/département/COMMUNE.shp|subset=\"NOM_COM\" = \'{}''\''.format(ville),
'OUTPUT':output2})
iface.addVectorLayer(output2,"","ogr")
landuse = QgsProject.instance().mapLayersByName('découpé')[0]

type = []
aire = []

with edit(landuse):
    for f in landuse.getFeatures():
        context.setFeature(f)
        f['aire'] = exp1.evaluate(context)
        landuse.updateFeature(f)

for f in landuse.getFeatures():
    aire.append(f["aire"])
    type.append(f["landuse"])
    
for f in aire:
    f = float(f)
aire[:] = [x / 1000000 for x in aire]
df = pd.DataFrame(type)
df = df.rename(columns={0: "Landuse"})
df["surface"] = aire

df = df.groupby(["Landuse"]).sum()
df = df.sort_values(["surface"], ascending=False)
other = df["surface"].iloc[4:].sum()
df = df.reset_index()
df["Landuse"] = df["Landuse"].replace(
    [
        "farmland",
        "military",
        "forest",
        "meadow",
        "residential",
        "farmyard",
        "grass",
        "industrial",
        "retail",
        "cemetery",
        "vineyard",
        "basin",
        "commercial",
        "village_green",
        "univeristy",
        "construction",
        "tourism",
        "healthcare",
        "quarry",
        "railway",
        "recreation_ground",
        "garages",
        "landfill",
        "brownfield",
        "port",
    ],
    [
        "Terres agricoles",
        "Militaire",
        "Terres boisées",
        "Pré/prairie",
        "Zones résidentielles",
        "Ferme",
        "Pelouse",
        "Industriel",
        "Marché",
        "Cimetière",
        "Vignoble",
        "Bassin",
        "Commercial",
        "Village vert",
        "Université",
        "Construction",
        "Tourisme",
        "Hôpitaux",
        "Carrière de surface",
        "Chemin de fer",
        "Terrains de loisirs",
        "Garages",
        "Décharge",
        "Friches industrielles",
        "Port",
    ],
)

line = {"Landuse": "Autre", "surface": other}
df = df.append(line, ignore_index=True)
df = df.iloc[[0, 1, 2, 3, -1]]
domaine = df["Landuse"].tolist()
surface = df["surface"].tolist()
aire = [round(num) for num in surface]

couleur = []
color = {
    "Terres agricoles": "gold",
    "Militaire": "peru",
    "Industriel": "red",
    "Pré/prairie": "wheat",
    "Terres boisées": "Green",
    "Autre": "lightgrey",
    "Zones résidentielles": "orangered",
    "Marché": "brown",
    "Vignoble": "blueviolet",
    "Construction": "orange",
    "Commercial": "yellow",
    "Pelouse": "lawngreen",
    "Tourisme": "chocolate",
    "Carrière de surface": "darkgrey",
    "Chemin de fer": "grey",
    "Terrains de loisirs": "pink",
    "Garages": "saddlebrown",
    "Décharge": "goldenrod",
    "Friches industrielles": "sienna",
    "port": "royalblue",
}

df["surface"] = df["surface"].round(decimals=1)
df = df.sort_values(by=["Landuse"], ascending=True)
liste = df["Landuse"].tolist()
set = []

liste = sorted(liste, reverse=False)
color = {key: value for key, value in sorted(color.items())}
for i, j in color.items():
    for k in liste:
        if i == k:
            set.append(j)
color = dict(zip(liste, set))
fig = px.pie(
    df,
    values="surface",
    names="Landuse",
    color="Landuse",
    color_discrete_map=color,
)

fig.update_traces(hovertemplate='Occupation : %{label}<br>Surface : %{value}km²')
fig.update_layout(
    title=f"Répartition de l'occupation du sol dans la ville de {ville}",
    font=dict(
        family="Arial",
        size=18,
    ),
)

fig.update_layout(font_family="Arial")
fig.write_html(f"C:/Users/Florian/Desktop/AASITE/public_html/file.html")
fig.write_image(f"C:/Users/Florian/Desktop/AASITE/public_html/imagr/Pontacq.svg")
fig.show()
</code></pre>
<br>
			<!-- End Post Content -->

			<!-- Begin Tags -->

			<!-- End Tags -->

		</div>
		<!-- End Post -->

	</div>
</div>
<!-- End Article
================================================== -->



<!-- Begin Related
================================================== -->


<!-- Begin Twitter Timeline
================================================== -->

<!-- End Twitter Timeline
================================================== -->

<!-- Begin AlertBar
================================================== -->

<!-- End AlertBar
================================================== -->

<!-- Begin Footer
================================================== -->
<!-- End Footer
================================================== -->

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="assets/js/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/ie10-viewport-bug-workaround.js"></script>
<script src="assets/js/mediumish.js"></script>
</body>
</html>

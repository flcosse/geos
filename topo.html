<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="auteur" content="">
<link rel="icon" href="imagr/planet-earth.png">
<title>Profil altimétrique</title>
<!-- Bootstrap core CSS -->
<link href="assets/css/bootstrap.min.css" rel="stylesheet">
<!-- Fonts -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
<!-- Custom styles for this template -->
<link href="assets/css/mediumish.css" rel="stylesheet">
</head>
<body>
    <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/python.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>
		
	</body>
<style>
	
</style>
<!-- Begin Nav
================================================== -->
<nav class="navbar navbar-toggleable-md navbar-light bg-white fixed-top mediumnavigation">
<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="container">
	<!-- Begin Logo -->
	<a class="navbar-brand" href="index.html">
	
	</a>
	<!-- End Logo -->
	<div class="collapse navbar-collapse" id="navbarsExampleDefault">
		<!-- Begin Menu -->
		<a class="navbar-brand" href="index.html">
            <img src="imagr/planet-earth.png" alt="logo">
            </a>
		<ul class="navbar-nav ml-auto">
			<li class="nav-item active">
			<a class="nav-link" href="propos.html">A propos <span class="sr-only">(current)</span></a>
			</li>
			
			
		</ul>
		<!-- End Menu -->
		<!-- Begin Search -->
		<form class="form-inline my-2 my-lg-0">
			<input class="form-control mr-sm-2" type="text" placeholder="Search">
			<span class="search-icon"><svg class="svgIcon-use" width="25" height="25" viewbox="0 0 25 25"><path d="M20.067 18.933l-4.157-4.157a6 6 0 1 0-.884.884l4.157 4.157a.624.624 0 1 0 .884-.884zM6.5 11c0-2.62 2.13-4.75 4.75-4.75S16 8.38 16 11s-2.13 4.75-4.75 4.75S6.5 13.62 6.5 11z"></path></svg></span>
		</form>
		<!-- End Search -->
	</div>
</div>
</nav>
<!-- End Nav
================================================== -->

<!-- Begin Article
================================================== -->
<div class="container">
	<div class="row">

		<!-- Begin Fixed Left Share -->
		<div class="col-md-2 col-xs-12">
			
		</div>
		<!-- End Fixed Left Share -->

		<!-- Begin Post -->
		<div class="col-md-8 col-md-offset-2 col-xs-12">
			<div class="mainheading">

				<!-- Begin Top Meta -->
				
				<!-- End Top Menta -->

				<h1 class="posttitle">Profil altimétrique avec PyQGIS</h1>
				
			</div>
            <div class="after-post-tags">
				<ul class="tags">
					<li><a href="#">Python</a></li>
					<li><a href="#">PyQGIS</a></li>
					<li><a href="#">Plotly</a></li>
					<li><a href="#">MNT</a></li>

				</ul>
			</div>

			<!-- Begin Featured Image -->
            <p>
                Un MNT (Modèle Numérique de Terrain) est importé dans le script. Différentes opérations comme des jointures ou des prélèvements de valeurs rasters interviendront pour collecter les données nécessaires à la réalisation du profil.<br>Les paramètres comme les noms des villes, l'altitude et la distance sont stockés dans des listes qui serviront à générer automatiquement le graphique avec Plotly.
            </p>
			<iframe src="profil.html"scrolling="no"frameBorder="0" height="40%" width="100%"  title=""></iframe>
			<!-- End Featured Image -->
     
			<!-- End Featured Image -->
			<!-- Begin Post Content -->

				<pre><code class="python">from statistics  import mean
import plotly.graph_objects as go
import numpy as np

iface.addVectorLayer("C:/Users/Florian/Desktop/département/COMMUNE.shp","","ogr")

def point(nom,x,y,lien):
    vl = QgsVectorLayer("Point", nom, "memory")
    pr = vl.dataProvider()
    pr.addAttributes([QgsField("nom", QVariant.String)])
    vl.updateFields() 
    f = QgsFeature()
    f.setGeometry(QgsGeometry.fromPointXY(QgsPointXY(x,y)))
    f.setAttributes([""])
    pr.addFeature(f)
    vl.updateExtents() 
    QgsProject.instance().addMapLayer(vl)
    path = lien
    writer = QgsVectorFileWriter.writeAsVectorFormat(vl,path,'utf-8',driverName='ESRI Shapefile')
    QgsProject.instance().removeMapLayer(vl)
    vl = iface.addVectorLayer(f"C:/Users/Florian/Desktop/département/{nom}.shp","","ogr")
    feat = next(iface.activeLayer().getFeatures())
    vl = QgsGeometry.asPoint(feat.geometry())
    pxy1 = QgsPoint(vl)

nom1 = "Point1"
nom2= "Point2"
coord1 = [-0.09770,43.19178]
coord2 = [-0.3481,43.3170]


point(nom1,coord1[0],coord1[1],f"C:/Users/Florian/Desktop/département/{nom1}.shp")
point(nom2,coord2[0],coord2[1],f"C:/Users/Florian/Desktop/département/{nom2}.shp")

def join(num,uri):
    processing.run("qgis:joinbylocationsummary", 
    {'INPUT':'C:/Users/Florian/Desktop/département/Point'+num+'.shp',
    'JOIN':'C:/Users/Florian/Desktop/département/COMMUNE.shp',
    'PREDICATE':[0],
    'JOIN_FIELDS':[],
    'SUMMARIES':[],
    'DISCARD_NONMATCHING':False,
    'OUTPUT':uri})
    iface.addVectorLayer(uri,"","ogr")
    
join("2",f"C:/Users/Florian/Desktop/département/POINTN2.shp")
join("1",f"C:/Users/Florian/Desktop/département/POINTN1.shp")

def rmvLyr(lyrname):
    qinst = QgsProject.instance()
    qinst.removeMapLayer(qinst.mapLayersByName(lyrname)[0].id())
    
for lyr in ['Point1', 'Point2']:
    rmvLyr(lyr)
    
def rename(old):
    vlayer  =QgsProject.instance().mapLayersByName(old)
    nom = [f["NOM_COM_mi"] for f in vlayer[0].getFeatures()]
    blockLayer = QgsProject.instance().mapLayersByName(old)[0] 
    blockLayer.setName(nom[0])

def name(n):
    vlayer  =QgsProject.instance().mapLayersByName(n)
    nom = [f["NOM_COM_mi"] for f in vlayer[0].getFeatures()]
    return nom

nom1 = name("POINTN1")
nom2 = name("POINTN2")
rename("POINTN1")
rename("POINTN2")

def line():
    start_point = QgsPoint(coord1[0],coord1[1])
    end_point = QgsPoint(coord2[0],coord2[1])
    v_layer = QgsVectorLayer('LineString?crs=epsg:4326', 'line', 'memory')
    path = (f"C:/Users/Florian/Desktop/département/Ligne.shp")
    pr = v_layer.dataProvider()
    seg = QgsFeature()
    seg.setGeometry(QgsGeometry.fromPolyline([start_point, end_point]))
    pr.addFeatures([ seg ])
    QgsProject.instance().addMapLayers([v_layer])
    iface.zoomToActiveLayer()
    writer = QgsVectorFileWriter.writeAsVectorFormat(v_layer,path,'utf-8',driverName='ESRI Shapefile')
    QgsProject.instance().removeMapLayer(v_layer)
    line = iface.addVectorLayer(f"C:/Users/Florian/Desktop/département/Ligne.shp","","ogr")

line()

line = QgsVectorLayer(f"C:/Users/Florian/Desktop/département/Ligne.shp","","ogr")
d = QgsDistanceArea()
d.setEllipsoid('WGS84')

for feat in line.getFeatures():
    dist_point = (d.convertAreaMeasurement(d.measureLength(feat.geometry()),100))
    
uri = f"C:/Users/Florian/Desktop/département/Relevés.shp"

processing.run("native:pointsalonglines", 
{'INPUT':'C:/Users/Florian/Desktop/département/Ligne.shp',
'DISTANCE':dist_point/35000000,
'START_OFFSET':0,
'END_OFFSET':0,
'OUTPUT':uri})

iface.addVectorLayer(uri,"","ogr")
iface.addRasterLayer("C:/Users/Florian/Downloads/EUDEM/eu_dem_v11_E30N20.TIF","Raster","gdal")

uri = f"C:/Users/Florian/Desktop/département/raster.shp"

processing.run("native:rastersampling", 
{'INPUT':'C:/Users/Florian/Desktop/département/Relevés.shp',
'RASTERCOPY':'C:/Users/Florian/Downloads/EUDEM/eu_dem_v11_E30N20.TIF',
'COLUMN_PREFIX':'SAMPLE_',
'OUTPUT':uri})
iface.addVectorLayer(uri,"","ogr")

uri = f"C:/Users/Florian/Desktop/département/matrice.shp"

processing.run("qgis:distancematrix",
{'INPUT':'C:/Users/Florian/Desktop/département/raster.shp',
'INPUT_FIELD':'FID',
'TARGET':'C:/Users/Florian/Desktop/département/raster.shp',
'TARGET_FIELD':'FID',
'MATRIX_TYPE':1,
'NEAREST_POINTS':0,
'OUTPUT':uri})
iface.addVectorLayer(uri,"","ogr")

matrice  =QgsProject.instance().mapLayersByName("matrice")
x = [f["0"] for f in matrice[0].getFeatures()]
haut  =QgsProject.instance().mapLayersByName("raster")
y = [f["SAMPLE_1"] for f in haut[0].getFeatures()]
x = [ '%.0f' % i for i in x ]
y = [ '%.1f' % i for i in y ]

layer = QgsVectorLayer(uri,"points","ogr")
X1 = []
Y1 = []

for i in layer.getFeatures():
    geom = i.geometry()
    X1.append(geom.asPoint().x())
    Y1.append(geom.asPoint().y())

X1 = [round(x, 3) for x in X1]
Y1 = [round(x, 3) for x in Y1]
x = [int(i) for i in x]
y = [float(i) for i in y]

fig = go.Figure(
    data=[
        go.Scatter(
            customdata=np.stack((X1, Y1), axis=1),
            x=x,
            y=y,
            hovertemplate="Distance : %{x:.0f}mAltitude : %{y:.0f}mX : %{customdata[0]:.3f}Y : %{customdata[1]:.3f}",
            fill="tozeroy",
            line_color="rgba(1,224,130,255)",
            mode="lines",
            fillcolor="rgba(1,224,130,0.18)",
            hoverinfo="none",
        )
    ],
    layout=dict(title=dict(text=f"Profil altimétrique, {nom1[0]} - {nom2[0]}")),
)

fig.update_layout(hoverlabel=dict(bgcolor="white", font_size=12, font_family="Arial"))
moyenne = mean(y)
moyenne = round(moyenne, 1)

maxi = int(round(float(max(y))))
mini = int(round(float(min(y))))

pente = round(((min(y) - max(y)) / max(x)) * 100, 1)
fig.update_layout(
    {
        "plot_bgcolor": "white",
        "paper_bgcolor": "white",
    }
)

fig.update_xaxes(zeroline=True, zerolinewidth=1, zerolinecolor="darkgrey")
fig.update_yaxes(zeroline=True, zerolinewidth=1, zerolinecolor="darkgrey")
chiffre = 240
color = f"rgb({chiffre}, {chiffre}, {chiffre})"

fig.update_yaxes(showgrid=True, gridwidth=0.1, gridcolor=color)
fig.update_xaxes(showgrid=True, gridwidth=0.1, gridcolor=color)
fig.update_layout(legend_itemdoubleclick=False)
fig.update(layout_yaxis_range=[mini * 0.9, maxi * 1.1])

fig.add_annotation(
    text=f"Longueur : {max(x)}m / Dénivelé : {round(min(y)-max(y),1)}m / Moyenne : {moyenne}m / Pente : {pente}%",
    xref="paper",
    yref="paper",
    x=0.5,
    y=-0.3,
    showarrow=False,
)
fig.add_annotation(
    text=f"Départ : {coord1[0]} / {coord1[1]} - Arrivée : {coord2[0]} / {coord2[1]} ",
    xref="paper",
    yref="paper",
    x=-0.02,
    y=1.19,
    showarrow=False,
)
fig.update_layout(
    hovermode="x unified",
    legend=dict(title=None),
    hoverlabel=dict(
        bgcolor="rgba(255,255,255,0.8)",
        font=dict(
            color="black",
            family="-apple-system,system-ui,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif",
            size=10,
        ),
    ),
)
fig.update_layout(
    font=dict(
        family="-apple-system,system-ui,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif",
        size=12,
    )
)

fig.update_xaxes(title_text="Distance")
fig.update_yaxes(title_text="Altitude")
fig.update_layout(margin={"r": 0, "l": 0})


fig.write_html(
    f"C:/Users/Florian/Desktop/AASITE/public_html/profil.html",
    config={"displayModeBar": False},
)

</code></pre>
<br>

			<!-- End Post Content -->

			<!-- Begin Tags -->

			<!-- End Tags -->

		</div>
		<!-- End Post -->

	</div>
</div>
<!-- End Article
================================================== -->



<!-- Begin Related
================================================== -->


<!-- Begin Twitter Timeline
================================================== -->

<!-- End Twitter Timeline
================================================== -->

<!-- Begin AlertBar
================================================== -->

<!-- End AlertBar
================================================== -->

<!-- Begin Footer
================================================== -->
<!-- End Footer
================================================== -->

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="assets/js/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/ie10-viewport-bug-workaround.js"></script>
<script src="assets/js/mediumish.js"></script>
</body>
</html>
